<!DOCTYPE html>
<html>

<head>
    <title>Create Activity</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .question-card {
            transition: transform 0.2s;
        }

        .question-card:hover {
            transform: translateY(-3px);
        }

        .template {
            display: none;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container py-5">
        <!-- Auth Check -->
        <div id="authCheck"></div>

        <!-- Header -->
        <div class="text-center mb-5">
            <h1 class="display-4 mb-3">Create New Quiz</h1>
            <div class="mb-4">
                <input type="text" id="activityName" class="form-control form-control-lg" placeholder="Quiz Title">
            </div>
        </div>

        <!-- Questions Container -->
        <div id="questionsContainer" class="row g-4"></div>

        <!-- Controls -->
        <div class="text-center mt-5">
            <button class="btn btn-primary btn-lg mx-2" onclick="addQuestion('trueFalse')">
                Add True/False Question
            </button>
            <button class="btn btn-primary btn-lg mx-2" onclick="addQuestion('fourAnswer')">
                Add Multiple Choice
            </button>
            <button class="btn btn-success btn-lg mx-2" onclick="finalizeActivity()">
                Create Quiz
            </button>
        </div>

        <!-- Templates -->
        <div class="template" id="trueFalseTemplate">
            <div class="question-card card shadow-sm mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title">True/False Question</h5>
                        <button class="btn btn-danger btn-sm" onclick="this.closest('.question-card').remove()">
                            Remove
                        </button>
                    </div>
                    <input type="text" class="form-control mb-3 questionText" placeholder="Enter your question">
                    <div class="responses">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox">
                            <label class="form-check-label">True</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox">
                            <label class="form-check-label">False</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="template" id="fourAnswerTemplate">
            <div class="question-card card shadow-sm mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title">Multiple Choice Question</h5>
                        <button class="btn btn-danger btn-sm" onclick="this.closest('.question-card').remove()">
                            Remove
                        </button>
                    </div>
                    <input type="text" class="form-control mb-3 questionText" placeholder="Enter your question">
                    <div class="responses">
                        <div class="input-group mb-2">
                            <div class="input-group-text">
                                <input class="form-check-input mt-0" type="checkbox">
                            </div>
                            <input type="text" class="form-control" placeholder="Answer option">
                        </div>
                        <div class="input-group mb-2">
                            <div class="input-group-text">
                                <input class="form-check-input mt-0" type="checkbox">
                            </div>
                            <input type="text" class="form-control" placeholder="Answer option">
                        </div>
                        <div class="input-group mb-2">
                            <div class="input-group-text">
                                <input class="form-check-input mt-0" type="checkbox">
                            </div>
                            <input type="text" class="form-control" placeholder="Answer option">
                        </div>
                        <div class="input-group">
                            <div class="input-group-text">
                                <input class="form-check-input mt-0" type="checkbox">
                            </div>
                            <input type="text" class="form-control" placeholder="Answer option">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Authentication check
        window.onload = () => {
            if (!localStorage.getItem('appKey')) {
                window.location.href = '/teacher.html';
            }
        };

        function addQuestion(type) {
            const template = document.getElementById(`${type}Template`);
            const clone = template.cloneNode(true);
            clone.classList.remove('template');

            // Initialize dynamic elements for 4-answer template
            if (type === 'fourAnswer') {
                const answerInputs = clone.querySelectorAll('.form-control[type="text"]');
                answerInputs.forEach((input, index) => {
                    input.placeholder = `Option ${index + 1}`;
                });
            }

            questionsContainer.appendChild(clone);
        }

        function collectQuestions() {
            return Array.from(document.querySelectorAll('.question-card')).map(questionEl => {
                const responses = Array.from(questionEl.querySelectorAll('.responses > div')).map((responseEl, i) => {
                    const textInput = responseEl.querySelector('input[type="text"]');
                    const checkbox = responseEl.querySelector('input[type="checkbox"]');

                    return {
                        text: textInput ? textInput.value : (i === 0 ? 'True' : 'False'),
                        correct: checkbox?.checked || false
                    };
                });

                // For True/False template
                if (!responses[0]?.text) {
                    responses.forEach((r, i) => r.text = i === 0 ? 'True' : 'False');
                }

                return {
                    text: questionEl.querySelector('.questionText').value,
                    responses: responses.filter(r => r.text.trim() !== '')
                };
            });
        }

        async function finalizeActivity() {
            const name = document.getElementById('activityName').value;
            const questions = collectQuestions().filter(q => q.text.trim() !== '');

            try {
                const response = await fetch(`/api/teachers/${localStorage.getItem('appKey')}/create_activity`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        name,
                        access: { "All": "All" },
                        config: { Quiz: { questions } }
                    })
                });

                if (!response.ok) throw new Error('Failed to create activity');
                // let datid = await response.json();

                alert('Quiz created successfully!');
                window.location.href = "teacher.html";
            } catch (error) {
                console.error(error);
                alert('Error creating quiz: ' + error.message);
            }
        }
    </script>
</body>

</html>